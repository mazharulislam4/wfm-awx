---
- name: Configure VMNetwork vSwitch
  hosts: localhost
  connection: local
  gather_facts: no

  vars_files:
    - credentials.yml

  vars:
    # Runtime parameters - must be passed via extra-vars
    # Required: esxi_host, esxi_username, esxi_password, vmnetwork_vswitch_name
    # Optional: vmnetwork_uplinks
    vmnet_vswitch_name: "{{ vmnetwork_vswitch_name }}"
    vmnet_uplinks: "{{ vmnetwork_uplinks | default(['vmnic4', 'vmnic5']) }}"

  tasks:
    - name: "Validate required runtime parameters"
      fail:
        msg: "Required parameters missing. Need: esxi_host, esxi_username, esxi_password, vmnetwork_vswitch_name"
      when: >
        esxi_host is not defined or esxi_host == "" or
        esxi_username is not defined or esxi_username == "" or
        esxi_password is not defined or esxi_password == "" or
        vmnet_vswitch_name is not defined or vmnet_vswitch_name == ""
    - name: Ensure VM Network vSwitch exists with specified uplinks
      community.vmware.vmware_vswitch:
        hostname: "{{ esxi_host }}"
        username: "{{ esxi_username }}"
        password: "{{ esxi_password }}"
        validate_certs: false
        esxi_hostname: "{{ esxi_host }}"
        switch: "{{ vmnet_vswitch_name }}"
        nics: "{{ vmnet_uplinks }}"
        state: present
      delegate_to: localhost
      register: vswitch_result

    - name: "Show VM Network vSwitch configuration result"
      debug:
        msg: "âœ… VM Network vSwitch '{{ vmnet_vswitch_name }}' configured with uplinks {{ vmnet_uplinks | join(', ') }}"

    - name: "Standardized output"
      set_fact:
        workflow_results:
          vmnetwork_vswitch:
            esxi_host: "{{ esxi_host }}"
            vswitch_name: "{{ vmnet_vswitch_name }}"
            uplinks: "{{ vmnet_uplinks }}"
            configuration_status: "{{ 'configured' if vswitch_result.changed else 'already_configured' }}"
            data: "{{ vswitch_result }}"
            job_type: "configure_vmnetwork_vswitch"
            status: "success"
