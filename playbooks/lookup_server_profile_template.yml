---
- name: Lookup Server Profile Template Moid Independently
  hosts: localhost
  connection: local
  gather_facts: no

  vars_files:
    - credentials.yml
  
  vars:
    server_profile_template: "{{ server_profile_template_name }}"

  tasks:
    - name: "Lookup Server Profile Template by Name"
      cisco.intersight.intersight_rest_api:
        api_key_id: "{{ intersight_api_key_id }}"
        api_private_key: "{{ intersight_api_private_key }}"
        api_uri: "{{ intersight_base_url }}"
        resource_path: "/server/ProfileTemplates"
        query_params:
          $filter: "Name eq '{{ server_profile_template }}'"
      register: template_lookup

    - name: "Debug Template Lookup"
      debug:
        var: template_lookup

    - name: "Check if template exists"
      fail:
        msg: "No server profile template found with name '{{ server_profile_template }}'"
      when: template_lookup.api_response is not defined

    - name: "Set fact for template Moid"
      set_fact:
        template_moid: "{{ template_lookup.api_response.Moid }}"

    - name: "Debug template Moid"
      debug:
        var: template_moid
