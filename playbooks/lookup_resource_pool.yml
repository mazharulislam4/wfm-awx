---
- name: Lookup Resource Pool Moid Independently
  hosts: localhost
  connection: local
  gather_facts: no

  vars_files:
    - credentials.yml

  vars:
    # Runtime parameters - can be passed via -e or AWX
    pool_name: "{{ resource_pool_name }}"

  tasks:
    - name: "Lookup Resource Pool by Name"
      cisco.intersight.intersight_rest_api:
        api_key_id: "{{ intersight_api_key_id }}"
        api_private_key: "{{ intersight_api_private_key }}"
        api_uri: "{{ intersight_base_url }}"
        resource_path: "/resourcepool/Pools"
        query_params:
          $filter: "Name eq '{{ resource_pool_name }}'"
      register: resource_pool_lookup

    - name: "Debug Resource Pool Lookup"
      debug:
        var: resource_pool_lookup

    - name: "Check if resource pool exists"
      fail:
        msg: "No resource pool found with name '{{ resource_pool_name }}'"
      when: resource_pool_lookup.api_response is not defined

    - name: "Set fact for resource pool Moid"
      set_fact:
        resource_pool_moid: "{{ resource_pool_lookup.api_response.Moid }}"
        workflow_results:
          resource_pool:
            name: "{{ pool_name }}"
            moid: "{{ resource_pool_lookup.api_response.Moid | default('') }}"
            data: "{{ resource_pool_lookup.api_response | default({}) }}"
            job_type: "lookup_resource_pool"
            status: "success"

    - name: Display results
      debug:
        var: resource_pool_moid
